#!/bin/bash

export MESA_BUILD_BASE_DIR=$HOME/build/mesa
export MESA_ROOT_DIR=$HOME/dev/mesa
export VK_GL_CTS_ROOT_DIR=$HOME/dev/VK-GL-CTS
export VK_GL_CTS_BUILD_DIR=$VK_GL_CTS_ROOT_DIR/build
export VULKAN_CTS_PATH=$VK_GL_CTS_ROOT_DIR/external/vulkancts
export OPENGL_CTS_PATH=$VK_GL_CTS_ROOT_DIR/external/openglcts
export MESA_VK_IGNORE_CONFORMANCE_WARNING=true

if [ "$#" -le 0 ]; then
    echo "usage: <driver> [build_dir_name]"
    exit 1
fi

driver=$1
build_dir_name=$2

if [ -z "$build_dir_name" ]; then
    build_dir_name=$driver
fi

case $driver in
    asahi)
        gallium_drivers_arg="asahi"
        vulkan_drivers_arg=""
        tools_args="nir,asahi"
        extra_meson_args="-Dllvm=disabled"
        ;;
    asahi+vk)
        gallium_drivers_arg="asahi"
        vulkan_drivers_arg="asahi-experimental"
        tools_args="nir,asahi"
        extra_meson_args="-Dllvm=disabled"
        ;;
    asahi+dvk)
        export CC=clang
        export CXX=clang++
        gallium_drivers_arg="asahi"
        vulkan_drivers_arg="asahi-experimental"
        tools_args="nir,asahi"
        extra_meson_args="-Dbuildtype=debug"
        ;;
    nouveau)
        gallium_drivers_arg="nouveau"
        vulkan_drivers_arg=""
        tools_args="nir,nouveau"
        extra_meson_args="-Dbuild-tests=true"
        ;;
    nouveau+vk)
        export NVK_I_WANT_A_BROKEN_VULKAN_DRIVER=1
        gallium_drivers_arg="nouveau"
        vulkan_drivers_arg="nouveau-experimental"
        tools_args="nir,nouveau"
        extra_meson_args="-Dbuildtype=debug"
        ;;
    *)
        echo "Unknown driver: $driver"
        exit 1
        ;;
esac

export MESA_BUILD_DIR=$MESA_BUILD_BASE_DIR/$build_dir_name

meson_args="-Dgallium-drivers=$gallium_drivers_arg -Dvulkan-drivers=$vulkan_drivers_arg -Dtools=$tools_args $extra_meson_args"

mkdir -p $MESA_BUILD_DIR

pushd $MESA_BUILD_DIR > /dev/null
meson setup $meson_args $MESA_ROOT_DIR

if [ $? -ne 0 ]; then
    meson setup --reconfigure $meson_args $MESA_ROOT_DIR

    if [ $? -ne 0 ]; then
        exit 1
    fi
fi
popd > /dev/null

export DEQP_JOBS=8

echo $MESA_BUILD_DIR
meson devenv -C $MESA_BUILD_DIR
